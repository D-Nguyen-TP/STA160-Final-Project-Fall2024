---
title: "STA160 Final Project Code"
author: "Duy Nguyen"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(sf)
library(TTR)
#library(ggfortify)
library(forecast)
library(tseries)
library(astsa)
```

```{r}
dat = read_csv("Sacramento Average Anomaly.csv")
```

```{r}
test = ts(dat$MAA, start = dat$Year[1], frequency = 1)
MA = SMA(dat$MAA, n = 15)
```
EDA Stuff
```{r}
ggplot(dat, mapping = aes(x = Year, y = MAA)) + 
  geom_line() + 
  geom_ribbon(aes(x = Year, y = MAA, ymin = MAA - Unc, ymax = MAA + Unc), alpha = 0.2) + 
  labs(title = "Sacramento Average Anomaly", x = "Years", y = "Average Anomaly") + 
  geom_line(aes(y = MA), color = "red") + 
  geom_smooth(color = "blue", fill = "red")
```

```{r}
ggplot(dat, aes(x = Year, y = Unc)) + geom_line() + labs(title = "Uncertainty levels of Sacramento Average Anomaly")
```

```{r}
series = ts(dat$MAA, start = dat$Year[1])

autoplot(ma(series, 15))
```

```{r}
full_raw = read_csv("Sacramento Data Anomaly FULL.csv")
```

```{r}
full = ts(full_raw$Temps, start = full_raw$Year[1], frequency = 12)
```

```{r}

autoplot(full)
ggsave("test.png", width = 7, height = 3)
```


```{r}
full %>% decompose() %>% autoplot() + 
  labs(title = "Decomposed Sacramento Time Series") + 
  scale_x_continuous(breaks = scales::extended_breaks(10))
```

## Splitting the Data

```{r}
first = ts(full_raw$Anomaly[1:120], start = full_raw$Year[1], frequency = 12)
last = ts(full_raw$Temps[1944:2064], start = full_raw$Year[1944], frequency = 12)

first %>% decompose() %>% autoplot()
last %>% decompose() %>% autoplot()
```

```{r}
# 5 folds cross validaation setup
splits = list(c(1:34), c(35:69), c(70:104), c(105:139), c(140:172))
dat[splits[[1]], ]
```

```{r}
June = full_raw %>% filter(Month == 6)
December = full_raw %>% filter(Month == 12)
```

```{r}
ggplot(December, aes(x = Year, y = Anomaly)) + 
  geom_line() + 
  geom_line(aes(y = ma(December$Anomaly, 15)), color = "red")

ggplot(June, aes(x = Year, y = Anomaly)) + 
  geom_line() + 
  geom_line(aes(y = ma(June$Anomaly, 15)), color = "red")

```

```{r}
seasonplot(last, col = rainbow(5))
```


```{r}
test_mod = auto.arima(dat$MAA)

pred = forecast(test_mod, h = 120)
autoplot(pred)

```

```{r}
test_mod = auto.arima(full, D = 1)

pred = forecast(test_mod, 36)

autoplot(pred)

```


